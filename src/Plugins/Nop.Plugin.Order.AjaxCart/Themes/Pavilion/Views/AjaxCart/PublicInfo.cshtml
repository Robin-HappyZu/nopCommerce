@using Nop.Core
@using Nop.Core.Infrastructure
@using Nop.Web.Framework.Themes
<!--Pavilion 指令-->
@{
    var themeContext = EngineContext.Current.Resolve<IThemeContext>();

    Html.AddCssFileParts("~/Plugins/Order.AjaxCart/Themes/" + themeContext.WorkingThemeName + "/Content/jquery.bootstrap-touchspin.min.css");
    Html.AddCssFileParts("~/Plugins/Order.AjaxCart/Themes/" + themeContext.WorkingThemeName + "/Content/ajaxCart.css");
    Html.AddScriptParts("~/Plugins/Order.AjaxCart/Themes/" + themeContext.WorkingThemeName + "/Content/jquery.bootstrap-touchspin.min.js");

}

<script>
    var interval = 0;
    $('.update-cart-button').hide();
    $(function() {
        var spin = $('.quantity .qty-input').TouchSpin();
        spin.on("touchspin.on.startspin", function() {
            if (interval > 0) {
                clearInterval(interval);
            }
        });

        spin.on("touchspin.on.stopspin", function() {
            interval = setInterval("UpdateCart()", 500);
        });

    });

    function UpdateCart() {

        var $form = $('#shopping-cart-form');
        var url = $form.attr("action");
        var loadTotal = '@Url.Action("LoadCart", "AjaxCart")';
        var params = $form.serializeArray();
        params.push({ name: "updatecart", value: "更新购物车" });
        $.post(url, params, function(data) {
            $.getJSON(loadTotal, function(jsonData) {
                var vm = jsonData;
                if (jsonData != null) {

                    if (jsonData.OrderTotals != null) {
                        if (jsonData.OrderTotals.SubTotal != null) {
                            $('.order-subtotal .value-summary').text(jsonData.OrderTotals.SubTotal);
                        }
                        if (jsonData.OrderTotals.Tax != null) {
                            $('.tax-value .value-summary').text(jsonData.OrderTotals.Tax);
                        }
                        if (jsonData.OrderTotals.Shipping != null) {
                            $('.shipping-cost .value-summary').text(jsonData.OrderTotals.Shipping);
                        }
                        if (jsonData.OrderTotals.OrderTotal != null) {
                            $('.order-total .value-summary').text(jsonData.OrderTotals.OrderTotal);
                        }
                        if (jsonData.OrderTotals.WillEarnRewardPoints != null) {
                            $('.earn-reward-points .value-summary').text(jsonData.OrderTotals.WillEarnRewardPoints);
                        }
                    }

                    if (jsonData.Items != null && jsonData.Items.length>0) {
                        for (var i = 0; i < jsonData.Items.length; i++) {
                            var item = jsonData.Items[i];
                            var row = $('input[name="itemquantity' + item.Id+'"]').parent().parent().parent();
                            row.find('.product-subtotal').text(item.SubTotal);
                        }
                    }
                }
            });
        });
        clearInterval(interval);
    }
</script>